#!/usr/bin/env bash

# fail if first argument not given
if [ -z "$1" ]; then
    echo "ERROR: No testbench file given"
    exit 1
fi

# The first argument to the script is expected to be the testbench file of a test.
# A testbench is defined as the kernel file prefixed with "tst_"
# This script will generate small driver scripts for running the various steps of
# the HLS synthesis and cosimulation.

# These scripts are partially for the lit driver to use, partially for a developer
# to use for debugging purposes; allowing us to simply run a script from within
# the test output directory, instead of manually writing paths all over.

# If run_test_scripts is piped after this script, it will run anything that we
# echo at it. So this is also the place where we define the testing order

tbSource=$1

gen_script() {
    scriptName=$1_driver.sh
    rm -f $scriptName
    touch $scriptName
    echo "#!/usr/bin/env bash" >> $scriptName
    echo "@CIRCT_HLS_BINARY_DIR@/bin/$1 ${tbSource}" >> $scriptName
    chmod +x $scriptName
    script_path="$(pwd)/$scriptName"
}

# Generate the script for incremental lowering. This is used by dyn_hlt_lower
gen_script dyn_incrementally_lower

# First, lower the kernel
gen_script dyn_hlt_lower
echo $script_path

# Then, build the simulator
gen_script dyn_hlt_build_sim
echo $script_path

# Then, build the testbench
gen_script dyn_hlt_build_tb
echo $script_path

# Then, generate testbench execution script. We'll postpone actually running
# it for now...
gen_script dyn_hlt_run_sim
