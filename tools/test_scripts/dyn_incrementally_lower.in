#!/usr/bin/env bash

# First argument is the source C file to lower. Output files are emitted
# in the working directory of the script.

set -e
basename=${1##*/}
basename=${basename%.*}
basename=${basename#tst_}
dirname=$(dirname $1)
testName="${dirname}/${basename}.c"

printf "= Dynamically scheduled HLS'ing $testName...\n"
fud exec --from c --to mlir-affine -o ${basename}_affine.mlir $testName
printf "\tLowered to affine! (Polygeist)...!"
fud exec --from mlir-affine --to mlir-std-flattened -o ${basename}_std.mlir ${basename}_affine.mlir
@CIRCT_HLS_BINARY_DIR@/bin/hls-opt --max-ssa="ignore-memref" ${basename}_std.mlir > ${basename}_std_max.mlir
printf "\r\tLowered to standard...!"
fud exec --from mlir-std-flattened --to mlir-handshake-buffered -o ${basename}_handshake.mlir ${basename}_std_max.mlir
printf "\r\tLowered to handshake...!"
fud exec --from mlir-handshake-buffered --to mlir-firrtl -o ${basename}_firrtl.mlir ${basename}_handshake.mlir
printf "\r\tLowered to FIRRTL...!"
fud exec --from mlir-firrtl --to synth-verilog -o ${basename}.sv ${basename}_firrtl.mlir
