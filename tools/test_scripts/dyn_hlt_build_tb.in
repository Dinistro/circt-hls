#!/usr/bin/env bash

# The first argument to the script is the kernel or testbench which the Simulator
# was generated from.
# A testbench is defined as the kernel file prefixed with "tst_"

set -e
sourceDir=$(dirname $1)
basename=${1##*/}
basename=${basename%.*}

if [[ "$basename" == "tst_"* ]]; then
    basename=${basename#tst_}
fi

# Lower polygeist to MLIR
@MLIR-CLANG_PATH@ \
  -S \
  --function=* \
  --memref-fullrank \
  $1 > ${basename}_poly.mlir

# lower polygeist subindexes to memrefs
@POLYGEIST-OPT_PATH@ \
  --lower-subindex ${basename}_poly.mlir > ${basename}_poly_memref.mlir

# Asynchronize to adhere with HLT. We assume that the testname is equal to the
# kernel name - which in turn is the function to asynchronize.
@CIRCT_HLS_BINARY_DIR@/bin/hls-opt --asyncify-calls="function=${basename}" \
  ${basename}_poly_memref.mlir > ${basename}_tb.mlir
