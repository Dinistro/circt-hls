#!/usr/bin/env bash

# The first argument to the script is the kernel or testbench which the Simulator
# was generated from.
# A testbench is defined as the kernel file prefixed with "tst_"
# It is assumed that the testbench function is named "main".

set -e
sourceDir=$(dirname $1)
basename=${1##*/}
basename=${basename%.*}

if [[ "$basename" == "tst_"* ]]; then
    basename=${basename#tst_}
fi

libdir="@LLVM_BINARY_DIR@/lib"

mlir-cpu-runner                                            \
    -e main -entry-point-result=i32 -O3                    \
    -shared-libs=${libdir}/libmlir_c_runner_utils.so       \
    -shared-libs=${libdir}/libmlir_runner_utils.so         \
    -shared-libs=libhlt_${basename}.so ${basename}_tb_llvm.mlir
